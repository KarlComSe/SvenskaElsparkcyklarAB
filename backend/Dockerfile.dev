FROM node:22-alpine

WORKDIR /app

RUN apk add --no-cache inotify-tools bash wget

RUN addgroup --system --gid 1001 appgroup && \
    adduser --system --uid 1001 \
    --ingroup appgroup \
    --disabled-password \
    --no-create-home \
    --home /app \
    --gecos "Application user" \
    appuser && \
    mkdir -p /var/log /app/dist /app/src/data && \
    chown -R appuser:appgroup /app /var/log /app/src/data && \
    chmod -R 755 /app && \
    chmod 777 /app/src/data

COPY package*.json ./

RUN chown appuser:appgroup package*.json 
USER appuser
RUN npm install --include=dev

USER root
COPY watch-package.json.sh ./
COPY start-dev.sh ./

RUN chmod +x watch-package.json.sh && \
    chmod +x start-dev.sh && \
    chown -R appuser:appgroup . && \
    chmod -R 775 /app /app/node_modules /app/dist

USER appuser
EXPOSE 3535

SHELL ["/bin/sh", "-c"]